{% extends 'core/base.html' %}
{% load static %}
{% block title %}Scanner{% endblock %}
{% block content %}

<!-- CSS del scanner -->
<link rel="stylesheet" href="{% static 'lectorqr/css/style_camara.css' %}">

<style>
  .card {
    margin-bottom: 20px;
    box-shadow: 0 0 1px rgba(0, 0, 0, .125), 0 1px 3px rgba(0, 0, 0, .2);
  }

  .card-header {
    font-weight: bold;
    text-align: center;
    background-color: #f8f9fa;
  }

  .center-block {
    float: none;
    margin-left: auto;
    margin-right: auto;
  }
</style>

<div class="row">
  <div class="col-md-12 center-block">

    <div class="card">

      <div class="card-header">
        Escanea un c贸digo QR
      </div>

      <div class="card-body">

        <div class="row">

          <!-- CMARA -->
          <div class="col-md-6">
            <div class="contenedor_camara">

              <div class="text-center" id="loadingMessage">
                 Aseg煤rese de habilitar la c谩mara web.
              </div>

              <canvas id="canvas" hidden></canvas>

              <div id="output" hidden style="margin-bottom:20px;">
                <div id="outputMessage">
                  A煤n no se ha detectado c贸digo QR
                </div>

                <div hidden>
                  <b style="color:#eeeeee;">C贸digo encontrado:</b>
                  <span id="outputData" style="color:#eeeeee;"></span>
                </div>

                {% csrf_token %}
              </div>

            </div>
          </div>

          <!-- RESULTADO -->
          <div class="col-md-6">
            <div id="resultado"></div>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>

<!-- AUDIO -->
<audio id="sonido_qr" style="display:none">
  <source src="{% static 'lectorqr/sonido/beep.mp3' %}" type="audio/mpeg">
</audio>

<!-- LIBRERA QR -->
<script src="{% static 'lectorqr/js/qr/jsQR.js' %}"></script>

<!-- SCRIPT SCANNER -->
<script src="{% static 'lectorqr/js/scanear_qr.js' %}"></script>

<!-- AJAX -->
<script>
  function guardar_codigo_escaneado(result_qr) {

    if (!result_qr) {
      alert("C贸digo vac铆o");
      return;
    }

    var csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

    $.ajax({
      type: "POST",
      url: "{% url 'view_detalles_paciente' %}",
      data: {
        datoqr: result_qr,
        csrfmiddlewaretoken: csrfToken
      },
      dataType: "json",

      success: function (response) {

        if (!response || response.id_paciente === undefined) {
          alert("Respuesta inv谩lida del servidor");
          return;
        }

        if (response.id_paciente === 0) {
          alert("No se encontr贸 ning煤n registro");
          return;
        }

        window.location.href =
          "{% url 'detalles_paciente' %}?id=" + response.id_paciente;
      },

      error: function (xhr, status, error) {
        console.error("Error en la petici贸n AJAX:", error);

        if (xhr.status === 403) {
          alert(" Tu sesi贸n ha caducado. Por favor, inicia sesi贸n nuevamente.");
          window.location.reload(); // Recarga para que Django redirija al login
        } else {
          alert(`锔 Error al procesar el c贸digo (${xhr.status}): ${error || "Error desconocido"}`);
        }
      }
    });
  }
</script>

{% endblock %}

